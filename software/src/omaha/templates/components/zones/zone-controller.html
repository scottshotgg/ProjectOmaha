<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="/bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="/bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="/bower_components/neon-animation/neon-animation.html">

<link rel="import" href="/components/simple-fit.html">
<link rel="import" href="/components/volume-selector.html">
<link rel="import" href="/components/light-controller.html">
<link rel="import" href="/components/averaging-controller.html">
<!--<link rel="import" href="/components/map-controller.html">-->
<dom-module id="zone-controller">
  <template>
    <style>
     :host {
        display: block;
      }
     
      .container {
        width: 100%;
      }
      
      .container-height {
        height: 100%;
      }
      
      volume-selector {
        width: 30%;
        min-width: 300px;
      }

      @media (min-width: 500px) {
        paper-radio-group {
          @apply(--layout-vertical);
        }

        paper-radio-button {
          @apply(--layout-horizontal);
          @apply(--layout-center);
        }

        #radio-container {
          @apply(--layout-horizontal)
        }
      }

      @media (max-width: 499px) {
        paper-radio-group {
          @apply(--layout-horizontal)
        }
        paper-radio-button {
          @apply(--layout-vertical);
          @apply(--layout-center);
        }

        #radio-container {
          @apply(--layout-vertical)
        }

        volume-selector, light-controller {
          margin-top: 20px;
        }

      }

    </style>
    <div id="radio-container" class="layout horizontal">
      <paper-radio-group selected="{{mode}}" id="mode">
        <paper-radio-button name="volume" class="flex">Volume</paper-radio-button>
        <!--<paper-radio-button name="averaging" class="flex">Averaging</paper-radio-button>-->
        <paper-radio-button name="light" class="flex">LED</paper-radio-button>
      </paper-radio-group>
    </div>
    <neon-animated-pages attr-for-selected="page" selected="[[mode]]" class="flex">
      <neon-animatable page="light" class="horizontal layout" entry-animation="slide-from-right-animation" exit-animation="slide-right-animation">
        <simple-fit class="container">
          <light-controller id="light" led-on="{{ledOn}}"></light-controller>
        </simple-fit>
      </neon-animatable>
      <neon-animatable page="volume" class="horizontal layout" entry-animation="slide-from-left-animation" exit-animation="slide-left-animation">
        <simple-fit class="container">
          <volume-selector id="volume" volume="{{volume}}"></volume-selector>
        </simple-fit>
      </neon-animatable>
    </neon-animated-pages>
    <iron-ajax
          id="speakerUpdateAjax"
          url="/system/speaker/"
          method="PUT"
          content-type="application/json"
          handle-as="json"
          on-response="_logResponse"
          debounce-duration="300"></iron-ajax>
  </template>
  <script>
    Polymer({
      is: 'zone-controller',

      behaviors: [
        Polymer.NeonAnimatableBehavior
      ],

      properties: {
        zone: {
          type: Object,
          observer: "_zoneUpdated"
        },

        isReady: {
          type: Boolean,
          value: false
        },

        mode: {
          type: String,
          value: "volume"
        },

        ledOn: {
          type: Boolean,
          value: true,
          observer: '_ledUpdate'
        },
        volume: {
          type: Number,
          value: 0,
          observer: '_volumeUpdate'
        },

        animationConfig: {
          value: function() {
            return {
              'entry': {
                  name: 'fade-in-animation',
                  node: this
                },
              'exit': {
                // provided by neon-animation-animations/fade-out-animation.html
                name: 'slide-left-animation',
                node: this
              }
            }
          }
        }
      },

      _ledUpdate: function() {
        /*
          We only want to notify the server of changes if this is after ready() has been called.
          This is because _ledUpdate is triggered when initially setting values received from the server
        */
        if(this.isReady) {
          var self = this;
          self.zone.speakers.forEach(function(speaker){
            speaker.ledOn = self.ledOn;
            var updatedAttributes = ["led"];
            var attributeValues = {
              "led": self.ledOn,
            };
            self.$.speakerUpdateAjax.body = {
              "updatedAttributes": updatedAttributes, 
              "attributeValues": attributeValues,
              "speaker": speaker.id
            };
            self.$.speakerUpdateAjax.generateRequest();
          });
          
        }
      },

      _volumeUpdate: function() {
        if(this.isReady) {
          var self = this;
          self.zone.speakers.forEach(function(speaker){
            speaker.volumeLevel = self.volume;
            var updatedAttributes = ["volume"];
            var attributeValues = {
              "volume": self.volume,
            };
            self.$.speakerUpdateAjax.body = {
              "updatedAttributes": updatedAttributes, 
              "attributeValues": attributeValues,
              "speaker": speaker.id
            };
            self.$.speakerUpdateAjax.generateRequest();
          });
        }

      },

      _logResponse: function(event, data) {
        console.log(data.response);
      },

      _initializeStatus: function(speaker) {
        this.ledOn = true;
        this.volume = 0;
      },

      _zoneUpdated: function() {
        this.isReady = false;
        this._initializeStatus();
        this.isReady = true;
      },

      ready: function() {
        if(this.speaker !== undefined)
          this._initializeStatus(this.speaker);
        this.isReady = true;
      }
    });
  </script>
</dom-module>