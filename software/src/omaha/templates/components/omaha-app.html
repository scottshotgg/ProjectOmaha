<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="/bower_components/iron-pages/iron-pages.html">
<link rel="import" href="/bower_components/neon-animation/neon-animation.html">
<link rel="import" href="/bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="/bower_components/paper-drawer-panel/paper-drawer-panel.html">

<link rel="import" href="/components/omaha-navbar.html">
<link rel="import" href="/components/speaker-controller.html">
<link rel="import" href="/components/map-controller.html">
<link rel="import" href="/components/open-map-controller.html">
<link rel="import" href="/components/zones/zone-map-controller.html">
<link rel="import" href="/components/zones/zone-controller.html">
<link rel="import" href="/components/account-creation-form.html">
<link rel="import" href="/components/zone-creation-form.html">
<link rel="import" href="/components/simple-fit.html">
<link rel="import" href="/components/omaha-drawer.html">

<dom-module id="omaha-app">
  <template>
    <style>
      :host {
        display: block;
        height: 100%;
      }
      @media (min-width: 769px) {
        .controller {
          @apply(--layout-horizontal)
        }
      }

      @media (max-width: 768px) {
        .controller {
          @apply(--layout-vertical)
        }
      }
      paper-drawer-panel {
        --paper-drawer-panel-left-drawer-container: {
          z-index: 2;
        };
      }
    </style>
    <paper-drawer-panel id="panel">
      <omaha-drawer id="drawer" drawer selected="{{selected}}"></omaha-drawer>
      <paper-header-panel class="flex" mode="seamed" main>
        <omaha-navbar id="nav" selected="{{selected}}" class="paper-header"></omaha-navbar>
        <neon-animated-pages on-iron-select="refreshMap" id="pages" attr-for-selected="page" class="fit" id="app-pages" selected="{{selected}}">
          <open-map-controller page="map" id="mapcontroller" zones="{{zones}}" controllers="[[controllers]]" class="fit"></open-map-controller>
          <zone-map-controller page="zoneMap" zones="{{zones}}" id="zoneMap"  controllers="[[controllers]]" class="fit"></zone-map-controller>
          <neon-animatable page="accountCreation" class="layout horizontal" entry-animation="slide-from-right-animation" exit-animation="slide-left-animation">
            <paper-material class="flex self-center card" elevation="5">
              <account-creation-form></account-creation-form>
            </paper-material>
          </neon-animatable> 
          <neon-animatable page="zoneCreation" class="layout horizontal" entry-animation="slide-from-right-animation" exit-animation="slide-left-animation">
            <paper-material class="flex self-center card" elevation="5">
              <zone-creation-form></zone-creation-form>
            </paper-material>
          </neon-animatable> 
          
          <speaker-controller class="controller" page="speakerController" id="controller" class="fit"></speaker-controller>
          <zone-controller class="controller" page="zoneController" id="zoneController" class="fit"></zone-controller>
        </neon-animated-pages>
        <paper-dialog id="dialog">
          <h2>Error</h2>
          <div>That speaker does not exist on the server</div>
          <div class="buttons layout vertical center">
            <paper-button dialog-confirm>Okay</paper-button>
          </div>
        </paper-dialog>
      </paper-header-panel>
    </paper-drawer-panel>
         <iron-ajax
            id="systemStatusAjax"
            url="/system/"
            content-type="application/json"
            handle-as="json"
            on-response="_initializeStatus"
            debounce-duration="300"></iron-ajax>
  </template>
  <script>

    var lastSelected = 0;

    Polymer({
      is: 'omaha-app',

      properties: {        
        selected: {
          type: String,
          value: "map"
        },
        zones: Object,
        controllers: Object
      },

      listeners: {
        'nav.backpressed': '_showMap',
        'drawer.showmap': '_showMap',
        'drawer.iron-select': '_closeDrawer',
        'nav.toggledrawer': '_toggleDrawer',
        'mapcontroller.speakerselected': '_speakerSelected',
        'mapcontroller.zoneselected': '_zoneSelected',
        'controller.equalizer.equalizerMenu.iron-select': '_presetSelectionChanged'
        // put a mapcontroller.logresponse thing here
      },

      _showMap: function() {
        this.selected = "map";
      },

      _presetSelectionChanged: function(event) {    // Why does this have event in the thing? It is not like that in volume selector
        console.log("hi");    // This says the speakerId is undefined
        },

      _speakerSelected: function(e) {
        console.log(this.$);
        var speaker = e.detail.speaker;
        console.log(e);
        console.log(speaker);     // just testing
        if(speaker === undefined) {
          this.$.dialog.open();
        } else {
          this.$.controller.speaker = speaker;
          console.log(this.$.speaker);
          this.$.nav.showBackArrow();

          this.selected = "speakerController";      // Don't put this in another listener because if someone clicks on the speaker and just wants to view, no sense in sending everything

          // Get controller object
          var controller = document.getElementById('controller');

          // Set volume levels
          document.getElementById('volume2').value = this.$.controller.speaker.VolumeLevel[0];
          document.getElementById('volume3').value = this.$.controller.speaker.VolumeLevel[1];
          document.getElementById('volume4').value = this.$.controller.speaker.VolumeLevel[2];
          document.getElementById('volume5').value = this.$.controller.speaker.VolumeLevel[3];

          console.log(document.getElementById('equalizerMenu'));

          // Set averaging mode
          document.getElementById('effectiveness').value = this.$.controller.speaker.AveragingMode;

          // Set paging levels
          document.getElementById('pagingvolume').value = this.$.controller.speaker.VolumeLevel[2];
          document.getElementById("fadetime").value = this.$.controller.speaker.FadeTime;
          document.getElementById("fadelevel").value = this.$.controller.speaker.FadeLevel;

          // Set equalizer bands
          var sliders = document.getElementsByClassName("ui-slider-range ui-widget-header ui-corner-all ui-slider-range-min");
          var handles = document.getElementsByClassName("ui-slider-handle ui-state-default ui-corner-all");
          for (i in controller.speaker.current) {
            sliders[i].style.height = (controller.speaker.Current[i] + 40) * 2 + "%";    // why does this have to be lower case
            handles[i].style.bottom = (controller.speaker.Current[i] + 40) * 2 + "%";
            $("#text" + (parseInt(i) + 1)).val(controller.speaker.Current[i]);
            iirConstants[i] = controller.speaker.Current[i];
          }

          // Polymer.dom.flush() idk if we need this anymore
          var listbox = document.getElementById("equalizerListbox");
          console.log(Polymer.dom(listbox).children);
          var motherPolymer = Polymer.dom(listbox).children; 

          // remove the paper-items from the last time and the other speakers, basically throwing away the stuff that we dont need
          if(motherPolymer.length > 1) {    // change that 2 to something that is not so fragile      // dont even need to check, think of the numerical analysis of checking
            for (var i = motherPolymer.length - 1; i > 1; i--)
              Polymer.dom(listbox).removeChild(motherPolymer[i]);
          
          }
          // injecting the paper-items for the presets
          if(controller.speaker.PresetNames.length > 0) {
            for (i in controller.speaker.PresetNames) {
              temp = document.createElement("paper-item");
              temp.setAttribute("value", controller.speaker.PresetNames[i].valueOf().replace("\n", ""));
              temp.setAttribute("id", controller.speaker.PresetNames[i].valueOf().replace("\n", ""));
              // temp.setAttribute("speakerId", controller.speaker.speakerId); try doing some optimization stuff with the speakerId
              temp.innerHTML = controller.speaker.PresetNames[i].valueOf().replace("\n", "");
              Polymer.dom(listbox).appendChild(temp);
            }
          }
        }
      },
      
      _zoneSelected: function(e) {
        var zone = e.detail.zone;
        this.$.zoneController.zone = zone;
        this.selected = "zoneController"
        this.$.nav.showBackArrow();
        console.log(zone);
      },

      _initializeStatus: function(event, data) {
        // add zone ID to each speaker
        var zones = data.response.zones;
        zones.forEach(function(zone){
          zone.speakers.forEach(function(speaker){
            speaker.zone = zone;
          });
        })
        // populate the speaker array
        var speakers = [];
        zones.forEach(function(zone){
          Array.prototype.push.apply(speakers, zone.speakers);
        })
        this.controllers = speakers
        this.zones = zones;
        this.$.mapcontroller.renderMap();
        this.$.zoneMap.renderMap();
      },

      _showAccountCreation: function() {
        this.selected = "accountCreation";
        this.$.nav.showAccountCreation = false;
      },

      _toggleDrawer: function() {
        this.$.panel.togglePanel();
      },
      
      _closeDrawer: function() {
        this.$.panel.closeDrawer();
      },
      
      refreshMap: function() {
        switch(this.$.pages.selected) {
          case "map":
          case "zoneMap":
            var map = this.$.pages.selectedItem.map;
            if(map !== undefined)
              map.updateSize();
        }
      },

      ready: function() {
        this.$.systemStatusAjax.generateRequest();
        this.$.nav.hideBackArrow();
        this.$.panel.forceNarrow = true;
      }

    });
  </script>
</dom-module>