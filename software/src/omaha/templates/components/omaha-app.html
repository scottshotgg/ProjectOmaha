<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="/bower_components/iron-pages/iron-pages.html">
<link rel="import" href="/bower_components/neon-animation/neon-animation.html">
<link rel="import" href="/bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="/bower_components/paper-drawer-panel/paper-drawer-panel.html">

<link rel="import" href="/components/omaha-navbar.html">
<link rel="import" href="/components/audio-controller.html">
<link rel="import" href="/components/map-controller.html">
<link rel="import" href="/components/open-map-controller.html">
<link rel="import" href="/components/account-creation-form.html">
<link rel="import" href="/components/simple-fit.html">
<dom-module id="omaha-app">
  <template>
    <style>
      :host {
        display: block;
        height: 100%;
      }
      @media (min-width: 500px) {
        audio-controller {
          @apply(--layout-horizontal)
        }
      }

      @media (max-width: 499px) {
        audio-controller {
          @apply(--layout-vertical)
        }
      }

    </style>
    <paper-drawer-panel id="panel">
      <div drawer class="title">Project Omaha</div>
      <paper-header-panel class="flex" mode="seamed" main>
        <omaha-navbar id="nav" selected="{{selected}}" class="paper-header"></omaha-navbar>
        <neon-animated-pages class="fit" id="app-pages" selected="{{selected}}">
          <open-map-controller id="mapcontroller" on-speakerselected="_speakerSelected" controllers="[[controllers]]" class="fit"></open-map-controller>
          <audio-controller id="controller" class="fit"></audio-controller>

          <neon-animatable class="layout horizontal" entry-animation="slide-from-right-animation" exit-animation="slide-left-animation">
            <paper-material class="flex self-center card" elevation="5">
              <account-creation-form></account-creation-form>
            </paper-material>
          </neon-animatable> 
        </neon-animated-pages>
        <paper-dialog id="dialog">
          <h2>Error</h2>
          <div>That speaker does not exist on the server</div>
          <div class="buttons layout vertical center">
            <paper-button dialog-confirm>Okay</paper-button>
          </div>
        </paper-dialog>
      </paper-header-panel>
    </paper-drawer-panel>
         <iron-ajax
            id="systemStatusAjax"
            url="/system/"
            content-type="application/json"
            handle-as="json"
            on-response="_initializeStatus"
            debounce-duration="300"></iron-ajax>
  </template>
  <script>
    Polymer({
      is: 'omaha-app',

      properties: {        
        selected: {
          type: Number,
          value: 0
        }
      },

      listeners: {
        'nav.backpressed': '_showMap',
        'nav.showaccountcreation': '_showAccountCreation',
        'nav.toggledrawer': '_toggleDrawer'
      },

      _showMap: function() {
        this.selected = 0;
        this.$.nav.showAccountCreation = true;
      },

      _speakerSelected: function(e) {
        var speakerId = e.detail.speakerId;
        var speaker;
        for(var i = 0; i < this.controllers.length; i++) {
          if(this.controllers[i].id == speakerId) {
            speaker = this.controllers[i];
            break;
          }
        }
        if(speaker === undefined) {
          this.$.dialog.open();
        } else {
          this.$.controller.speaker = speaker;
          this.$.nav.showBackArrow();
          this.selected = 1;
        }
      },

      _initializeStatus: function(event, data) {
        var controllers = new Array();
        var controllersMap = data.response.status.controllers
        for(var id in controllersMap) {
          controllers.push(controllersMap[id])
        }
        this.controllers = controllers
        this.$.mapcontroller.renderMap();
      },

      _showAccountCreation: function() {
        this.selected = 2;
        this.$.nav.showAccountCreation = false;
      },

      _toggleDrawer: function() {
        this.$.panel.togglePanel();
      },

      ready: function() {
        this.$.systemStatusAjax.generateRequest();
        this.$.nav.hideBackArrow();
        this.$.nav.showAccountCreation = true;
        this.$.panel.forceNarrow = true;
      }

    });
  </script>
</dom-module>