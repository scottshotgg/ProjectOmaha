<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="/bower_components/iron-form/iron-form.html">
<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/neon-animation/neon-animation.html">
<link rel="import" href="/bower_components/paper-styles/paper-styles.html">
<link rel="import" href="/bower_components/paper-toast/paper-toast.html">

<link rel="import" href="/components/omaha-app.html">


<link rel="shortcut icon" href="favicon.ico" type="image/x-icon"/ >

<dom-module id="login-form">
  <template>
    <style>
      :host {
        display: block;
      }
      .form-title {
        margin-bottom: 20px;
      }
      
      .company {
        color: #3f51b5;
        font-size: 20px;
        font-weight: 500;
        margin-bottom: 5px;
      }
      
      paper-button {
        background-color: #3f51b5;
        color: #fff;
        margin-top: 20px;
        width: 100%;
      }

      .message {
        color: var(--paper-red-500);
      }

      .hidden {
        display: none;
      }
    </style>
    <div class="flex company">Project Omaha</div>
    <template is="dom-if" if="{{redirect}}">
      <div class="message">Please login before proceeding</div>
    </template>
    <div class="message">{{err}}</div>
    <form on-iron-form-submit="_submit" is="iron-form" id="form"  method="post">
      <paper-input id="username" name="username" label="Username" required></paper-input>
      <paper-input id="password" name="password" label="Password" type="password" required></paper-input>
      <paper-button type="submit" raised on-click="_submit">Login</paper-button>
      <!-- We should be able to press enter to submit. This button with type submit is required to do so. -->
      <button class="hidden" type="submit">I should be hidden</button>
    </form>
    <iron-ajax
        id="loginAjax"
        url="/login/"
        method="POST"
        content-type="application/json"
        handle-as="json"
        on-response="_handleLogin"
        debounce-duration="300"></iron-ajax>
    <paper-toast id="toast"><span>{{err}}</span></paper-toast>
  </template>
  <script>
    Polymer({
      is: 'login-form',

      _submit: function() {
        var loginInfo = {

        }
        this.$.loginAjax.body = {
          username: this.$.username.value,
          password: this.$.password.value
        }
        this.$.loginAjax.generateRequest();
      },

      _handleLogin: function(event, data, x) {
        console.log(data.response);
        localStorage.setItem('level', data.response.level);
        localStorage.setItem('speakerid', data.response.speakerid);
        localStorage.setItem('zoneid', data.response.zoneid);
        if(data.response.hash !== undefined) {
          var sessionCookie = data.response.hash;
          document.cookie = "session=" + sessionCookie + ";";
          document.location.href = "/app/"
        } else if (data.response.success){
          document.location.href = "/app/"
        } else {
          console.log(data.response);
          this.err = data.response.err;
          this.$.toast.show();
        }
      }
    });
  </script>
</dom-module>